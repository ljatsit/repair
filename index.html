  <!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ລະບົບອອກໃບຢັ້ງຢືນສ້ອມແປງ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Noto Sans Lao font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Load Font Awesome Icons (for the icon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #059669; /* Emerald 600 */
        }
        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 1000px;
        }
        /* Custom scrollbar style for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e7ff;
        }
        /* Style for the fixed header */
        header {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.2);
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <header class="bg-white sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <!-- Title and Icon -->
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-screwdriver-wrench text-2xl text-emerald-600"></i>
                <h1 class="text-xl font-semibold text-gray-800">
                    NECESSARY OF REPAIR SYSTEM |  ລະບົບອອກໃບຢັ້ງຢືນສ້ອມແປງ
                </h1>
            </div>
            <!-- Navigation -->
            <nav class="space-x-4 flex items-center">
                <a href="#add-data" class="text-lg font-medium text-emerald-600 hover:text-emerald-700 transition duration-150 p-2 rounded-lg bg-emerald-50">
                    <i class="fa-solid fa-circle-plus mr-1"></i> ເພີ່ມຂໍ້ມູນ
                </a>
                <button 
                    onclick="openPrintView()"
                    class="text-lg font-medium text-gray-600 hover:text-gray-800 transition duration-150 p-2 rounded-lg hover:bg-gray-100"
                    title="ເປີດແຖບໃໝ່ເພື່ອເບິ່ງຂໍ້ມູນ ແລະ ພິມອອກ"
                >
                    <i class="fa-solid fa-print mr-1"></i> ອອກໃບຢັ້ງຢືນສ້ອມແປງ
                </button>
                <button 
                    onclick="openPrintView1()"
                    class="text-lg font-medium text-gray-600 hover:text-gray-800 transition duration-150 p-2 rounded-lg hover:bg-gray-100"
                    title="ເປີດແຖບໃໝ່ເພື່ອເບິ່ງຂໍ້ມູນ ແລະ ພິມອອກ"
                >
                    <i class="fa-solid fa-print mr-1"></i> ອອກໃບສັ່ງຊື້
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8" id="add-data">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-emerald-500 pb-2">
            NECESSARY OF REPAIR | ເພີ່ມຂໍ້ມູນໃບຢັ້ງຢືນສ້ອມແປງ
        </h2>

        <!-- Alert/Message Box -->
        <div id="message-box" class="hidden p-4 rounded-lg mb-6 transition duration-300" role="alert">
            <p id="message-text" class="font-medium"></p>
        </div>
        
        <!-- Data Entry Form -->
        <form id="data-entry-form" class="bg-white p-6 md:p-10 rounded-xl shadow-lg">
            
            <!-- ID and Date Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="input-group">
                    <label for="record-id">ID (ເລກທີ່):</label>
                    <input type="text" id="record-id" name="id" class="bg-gray-100 text-gray-600 font-bold" value="ກຳລັງໂຫລດ..." readonly>
                </div>
                <div class="input-group">
                    <label for="employee-id">ລະຫັດພະນັກງານ:</label>
                    <input type="text" id="employee-id" name="employeeId" maxlength="110" required>
                </div>
                <div class="input-group">
                    <label for="record-date">ວັນທີ:</label>
                    <input type="date" id="record-date" name="date" required>
                </div>
            </div>

            <!-- Details Section -->
            <h3 class="text-xl font-semibold text-emerald-700 mb-4 border-b pb-1">ລາຍລະອຽດການສ້ອມແປງ (Description) | ເພີ່ມສູງສຸດ 110 ຕົວອັກສອນ/ຊ່ອງ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <!-- Detail 1-3 -->
                <div class="input-group"><label for="detail-1">ລາຍລະອຽດ 1:</label><input type="text" id="detail-1" name="detail1" maxlength="110"></div>
                <div class="input-group"><label for="detail-2">ລາຍລະອຽດ 2:</label><input type="text" id="detail-2" name="detail2" maxlength="110"></div>
                <div class="input-group"><label for="detail-3">ລາຍລະອຽດ 3:</label><input type="text" id="detail-3" name="detail3" maxlength="110"></div>
                <!-- Detail 4-6 -->
                <div class="input-group"><label for="detail-4">ລາຍລະອຽດ 4:</label><input type="text" id="detail-4" name="detail4" maxlength="110"></div>
                <div class="input-group"><label for="detail-5">ລາຍລະອຽດ 5:</label><input type="text" id="detail-5" name="detail5" maxlength="110"></div>
                <div class="input-group"><label for="detail-6">ລາຍລະອຽດ 6:</label><input type="text" id="detail-6" name="detail6" maxlength="110"></div>
            </div>
            <!-- Detail 7 and Department -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                 <div class="input-group md:col-span-2">
                     <label for="detail-7">ລາຍລະອຽດ 7:</label>
                     <input type="text" id="detail-7" name="detail7" maxlength="110">
                 </div>
                 <div class="input-group">
                    <label for="department">ແຜນກ:</label>
                    <select id="department" name="department" required>
                        <option value="PA">PA</option>
                        <option value="FA">FA</option>
                        <option value="MK">MK</option>
                        <option value="QS">QS</option>
                        <option value="RH">RH</option>
                        <option value="PS">PS</option>
                        <option value="LC">LC</option>
                        <option value="SS">SS</option>
                        <option value="TC">TC</option>
                        <option value="FM">FM</option>
                        <option value="FM/FE">FM/FE</option>
                        <option value="FM/IT" selected>FM/IT</option>
                    </select>
                </div>
            </div>

            <!-- Checker Section -->
            <h3 class="text-xl font-semibold text-emerald-700 mb-4 border-b pb-1">ການກວດສອບ (Finding After Checking) | ເພີ່ມສູງສຸດ 110 ຕົວອັກສອນ/ຊ່ອງ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="input-group"><label for="checker-1">ກວດສອບ 1:</label><input type="text" id="checker-1" name="checker1" maxlength="110"></div>
                <div class="input-group"><label for="checker-2">ກວດສອບ 2:</label><input type="text" id="checker-2" name="checker2" maxlength="110"></div>
                <div class="input-group"><label for="checker-3">ກວດສອບ 3:</label><input type="text" id="checker-3" name="checker3" maxlength="110"></div>
                <div class="input-group">
                    <label for="checker-4">ກວດສອບ 4:</label>
                    <input type="text" id="checker-4" name="checker4" value="(Forward to PA make a request)" maxlength="110">
                </div>
            </div>
            
            <!-- Purchase Section -->
            <h3 class="text-xl font-semibold text-emerald-700 mb-4 border-b pb-1">ລາຍການຂໍສັ່ງຊື້ເພື່ອສ້ອມແປງ (Request for Repairing / Proposal)  | ເພີ່ມສູງສຸດ 110 ຕົວອັກສອນ/ຊ່ອງ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="input-group"><label for="purchase-1">ສັ່ງຊື້ 1:</label><input type="text" id="purchase-1" name="purchase1" maxlength="110"></div>
                <div class="input-group"><label for="purchase-2">ສັ່ງຊື້ 2:</label><input type="text" id="purchase-2" name="purchase2" maxlength="110"></div>
                <div class="input-group"><label for="purchase-3">ສັ່ງຊື້ 3:</label><input type="text" id="purchase-3" name="purchase3" maxlength="110"></div>
                <div class="input-group"><label for="purchase-4">ສັ່ງຊື້ 4:</label><input type="text" id="purchase-4" name="purchase4" maxlength="110"></div>
            </div>

             <!-- Purchase Section -->
            <h3 class="text-xl font-semibold text-emerald-700 mb-4 border-b pb-1">ຈຸດປະສົ່ງອອກໃບສັ່ງຊື້ (ສະເພາະອອກໃບສັ່ງຊື້ເທົ່ານັ້ນ)  | ເພີ່ມສູງສຸດ 500 ຕົວອັກສອນ/ຊ່ອງ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="input-group"><label for="purchase-5">ລາຍການສັ່ງຊື້ (Description for Purchasing):</label> <textarea id="purchase-5" name="purchase5" maxlength="500" rows="4" class="w-full border rounded p-2"></textarea></div>
                <div class="input-group"><label for="purchase-6">ເຫດຜົນຂອງການຂໍສັ່ງຊື້ (Reason of Purchasing):</label> <textarea id="purchase-6" name="purchase6" maxlength="500" rows="4" class="w-full border rounded p-2"></textarea></div>
                
            </div>

            <!-- Save Button -->
            <div class="text-center">
                <button type="submit" id="save-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-10 rounded-full transition duration-300 transform hover:scale-105 disabled:bg-gray-400">
                    <i class="fa-solid fa-floppy-disk mr-2"></i> ບັນທຶກຂໍ້ມູນ
                </button>
            </div>
        </form>
    </main>

    <script>
        // *** 1. Configuration ***
        // URL ຂອງ Google Apps Script ທີ່ທ່ານໄດ້ສ້າງ
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQiesHEfC-7-93D2J21ONFvMp_nFlFYKX-FqExYvOfxjdW1bpRhjRotevNE38YlH8stA/exec';
        
        // URL ຂອງ Google Sheet ສຳລັບເບີ່ງ/ພິມອອກ
        const SPREADSHEET_PRINT_URL = 'https://docs.google.com/spreadsheets/d/1oggMTfwivAyA-SmrV0VVV7PjpGcBWFTB_d1ELFEr-G4/edit?usp=sharinghttps://docs.google.com/spreadsheets/d/1oggMTfwivAyA-SmrV0VVV7PjpGcBWFTB_d1ELFEr-G4/edit?gid=2116115900#gid=2116115900';
        
         // URL ຂອງ Google Sheet ສຳລັບເບີ່ງ/ພິມອອກ
        const SPREADSHEET_PRINT_URL1 = 'https://docs.google.com/spreadsheets/d/1oggMTfwivAyA-SmrV0VVV7PjpGcBWFTB_d1ELFEr-G4/edit?gid=1821582580#gid=1821582580';
        
        const form = document.getElementById('data-entry-form');
        const recordIdInput = document.getElementById('record-id');
        const dateInput = document.getElementById('record-date');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const saveButton = document.getElementById('save-button');

        // *** 2. Utility Functions ***
        
        // ຕັ້ງຄ່າວັນທີປັດຈຸບັນ
        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        }
        
        // ສະແດງຂໍ້ຄວາມແຈ້ງເຕືອນ
        function showMessage(type, message) {
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-700', 'text-green-700');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            }
            messageText.textContent = message;
            // ເຊື່ອງຂໍ້ຄວາມຫຼັງ 5 ວິນາທີ
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // *** 3. Data Fetching and Generation ***
        
        // ໂຫລດ ID ຕໍ່ໄປຈາກ Apps Script
        async function fetchNextId() {
            // ປິດການໂຫລດ ID ຊົ່ວຄາວ ເພື່ອປ້ອງກັນບໍ່ໃຫ້ມັນສະແດງຂໍ້ຄວາມ "ກຳລັງໂຫລດ..." ທຸກໆ 2 ວິນາທີ
            // ຖ້າຫາກປຸ່ມບັນທຶກບໍ່ໄດ້ຖືກກົດເທື່ອ
            if (saveButton.disabled && saveButton.textContent !== 'ບັນທຶກຂໍ້ມູນ') {
                 // ບໍ່ຕ້ອງປ່ຽນຂໍ້ຄວາມຖ້າມັນກຳລັງບັນທຶກຢູ່
            } else {
                //  recordIdInput.value = 'ກຳລັງໂຫລດ...';
            }
            
            try {
                // ໃຊ້ GET request ທີ່ບໍ່ມີ parameter ເພື່ອຂໍ ID ຕໍ່ໄປ
                // ຈັດການກັບການລອງໃໝ່ຖ້າມີຂໍ້ຜິດພາດ (exponential backoff)
                const maxRetries = 5;
                let lastData = null;

                for (let i = 0; i < maxRetries; i++) {
                    const response = await fetch(APPS_SCRIPT_URL);
                    const data = await response.json();
                    lastData = data;
                    
                    if (data.nextId) {
                        recordIdInput.value = data.nextId;
                        saveButton.disabled = false;
                        saveButton.textContent = 'ບັນທຶກຂໍ້ມູນ';
                        return; // ສຳເລັດ, ອອກຈາກຟັງຊັນ
                    }
                    
                    // ຖ້າບໍ່ສຳເລັດ, ລໍຖ້າກ່ອນລອງໃໝ່
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }

                // ຖ້າລອງຄົບ Max Retries ແລ້ວ
                if (lastData && lastData.error) {
                    recordIdInput.value = 'ຜິດພາດ';
                    showMessage('error', `ບໍ່ສາມາດໂຫລດ ID: ${lastData.error}`);
                } else {
                    recordIdInput.value = 'N/A';
                    showMessage('error', ' Apps Script ຕອບກັບຜິດພາດ.');
                }
                saveButton.disabled = true;

            } catch (error) {
                recordIdInput.value = 'ຜິດພາດ';
                showMessage('error', `ການເຊື່ອມຕໍ່ຜິດພາດ. ກະລຸນາກວດສອບ Apps Script. (${error.message})`);
                console.error("Fetch ID Error:", error);
                saveButton.disabled = true;
            }
        }
        
        // ເປີດແທັບໃໝ່ສຳລັບເບີ່ງຂໍ້ມູນ/ພິມອອກ
        function openPrintView() {
            // ເປີດໄປທີ່ URL ຂອງ Sheet ໂດຍກົງ.
            window.open(SPREADSHEET_PRINT_URL, '_blank');
        }

           // ເປີດແທັບໃໝ່ສຳລັບເບີ່ງຂໍ້ມູນ/ພິມອອກ
        function openPrintView1() {
            // ເປີດໄປທີ່ URL ຂອງ Sheet ໂດຍກົງ.
            window.open(SPREADSHEET_PRINT_URL1, '_blank');
        }

        // *** 4. Form Submission Logic ***

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const originalButtonText = saveButton.textContent;
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> ກຳລັງບັນທຶກ...';

            // ດຶງຂໍ້ມູນຈາກ Form
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                // ສົ່ງຂໍ້ມູນໄປທີ່ Apps Script ດ້ວຍ POST request
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // ໃຊ້ no-cors ຍ້ອນການຕັ້ງຄ່າ Apps Script ເປັນມາດຕະຖານ
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    // ປ່ຽນ Object ໃຫ້ເປັນ URL-encoded string
                    body: new URLSearchParams(data).toString()
                });

                // ລໍຖ້າ 3 ວິນາທີເພື່ອໃຫ້ Google Sheet ບັນທຶກສຳເລັດ (ຈຳລອງ)
                setTimeout(() => {
                    // *** THIS IS THE SWEETALERT CODE ***
                    Swal.fire({
                      title: 'ບັນທຶກສຳເລັດ!',
                      html: `ເອກະສານເລກທີ: ${data.id} ຖືກບັນທຶກລົງໃນຖານຂໍ້ມູນຮຽບຮ້ອຍແລ້ວ.`,
                      icon: 'success',
                      confirmButtonText: 'ຕົກລົງ',
                      confirmButtonColor: '#059669', // Emerald 600
                      customClass: {
                            confirmButton: 'font-medium'
                      }
                    });

                    form.reset();
                    setTodayDate();
                    // fetchNextId will automatically update the ID after the delay
                }, 3000); 

            } catch (error) {
                showMessage('error', `ການບັນທຶກຜິດພາດ: ${error.message}. ກະລຸນາກວດສອບ Apps Script.`);
                console.error("Submission Error:", error);
                saveButton.disabled = false;
                saveButton.textContent = originalButtonText; // ກັບຄືນຂໍ້ຄວາມເດີມ
            }
        });

        // *** 5. Initialization ***
        window.onload = function() {
            setTodayDate();
            
            // ໂຫລດ ID ທັນທີເມື່ອເປີດໜ້າ
            fetchNextId();
            
            // ໂຫລດ ID ໃໝ່ທຸກໆ 2 ວິນາທີ (2000ms)
            setInterval(fetchNextId, 2000); 

            // ເພີ່ມ event listener ໃຫ້ກັບປຸ່ມເບິ່ງ/ພິມອອກ
            document.querySelector('button[onclick="openPrintView()"]').addEventListener('click', openPrintView);
        };
    </script>

</body>
</html>